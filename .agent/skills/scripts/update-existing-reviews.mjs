#!/usr/bin/env node

/**
 * Update Existing Reviews List
 * 
 * Scans all EN reviews and updates prompts/existing-reviews-hardwarelab.md
 * with the current list of review titles and slugs.
 * 
 * Usage:
 *   node scripts/update-existing-reviews.mjs
 * 
 * Run by QA after successful build to keep the list current.
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Configuration
const REVIEWS_DIR = path.join(__dirname, '../../..', 'src', 'content', 'reviews', 'en');
const OUTPUT_FILE = path.join(__dirname, '../../..', 'prompts', 'existing-reviews-hardwarelab.md');

/**
 * Extract title from MDX frontmatter
 */
function extractTitle(content) {
    const match = content.match(/^---\s*\n([\s\S]*?)\n---/);
    if (!match) return null;

    const frontmatter = match[1];
    const titleMatch = frontmatter.match(/^title:\s*["']?(.+?)["']?\s*$/m);
    return titleMatch ? titleMatch[1].replace(/^["']|["']$/g, '') : null;
}

/**
 * Extract category from MDX frontmatter
 */
function extractCategory(content) {
    const match = content.match(/^---\s*\n([\s\S]*?)\n---/);
    if (!match) return 'unknown';

    const frontmatter = match[1];
    const categoryMatch = frontmatter.match(/^category:\s*["']?(.+?)["']?\s*$/m);
    return categoryMatch ? categoryMatch[1].replace(/^["']|["']$/g, '') : 'unknown';
}

function main() {
    console.log('ðŸ“‚ Scanning reviews in:', REVIEWS_DIR);

    // Check if reviews directory exists
    if (!fs.existsSync(REVIEWS_DIR)) {
        console.error('âŒ Error: Reviews directory not found:', REVIEWS_DIR);
        process.exit(1);
    }

    // Get all review folders
    const folders = fs.readdirSync(REVIEWS_DIR, { withFileTypes: true })
        .filter(dirent => dirent.isDirectory())
        .map(dirent => dirent.name)
        .filter(name => !name.startsWith('_')) // Skip folders starting with _
        .sort();

    console.log(`ðŸ“ Found ${folders.length} review folders\n`);

    const reviews = [];
    const byCategory = {};

    for (const slug of folders) {
        const indexPath = path.join(REVIEWS_DIR, slug, 'index.mdx');

        if (!fs.existsSync(indexPath)) {
            console.warn(`âš ï¸  Skipping ${slug}: no index.mdx`);
            continue;
        }

        const content = fs.readFileSync(indexPath, 'utf-8');
        const title = extractTitle(content);
        const category = extractCategory(content);

        if (!title) {
            console.warn(`âš ï¸  Skipping ${slug}: no title in frontmatter`);
            continue;
        }

        reviews.push({ slug, title, category });

        if (!byCategory[category]) {
            byCategory[category] = [];
        }
        byCategory[category].push({ slug, title });
    }

    // Generate markdown content
    const now = new Date().toISOString().split('T')[0];
    let output = `# Existing Reviews - HardwareLab

**Auto-generated by \`scripts/update-existing-reviews.mjs\`**  
**Last updated:** ${now}  
**Total reviews:** ${reviews.length}

---

## How to Use

When adding internal links in reviews, **copy-paste** the exact URL and title from this list.

**Format:** \`[Exact Title](/reviews/slug)\`

---

## All Reviews (alphabetical)

| Title | URL |
|-------|-----|
`;

    // Add all reviews alphabetically
    const sortedReviews = [...reviews].sort((a, b) => a.title.localeCompare(b.title));
    for (const { slug, title } of sortedReviews) {
        output += `| ${title} | \`/reviews/${slug}\` |\n`;
    }

    // Add by category
    output += `\n---\n\n## By Category\n`;

    const categoryOrder = ['gaming', 'gaming-pcs', 'monitors', 'ai-workstation', 'mini-pc', 'nas', 'sbc'];

    for (const category of categoryOrder) {
        if (byCategory[category] && byCategory[category].length > 0) {
            output += `\n### ${category} (${byCategory[category].length})\n\n`;
            for (const { slug, title } of byCategory[category].sort((a, b) => a.title.localeCompare(b.title))) {
                output += `- [${title}](/reviews/${slug})\n`;
            }
        }
    }

    // Handle unknown categories
    for (const category of Object.keys(byCategory)) {
        if (!categoryOrder.includes(category)) {
            output += `\n### ${category} (${byCategory[category].length})\n\n`;
            for (const { slug, title } of byCategory[category].sort((a, b) => a.title.localeCompare(b.title))) {
                output += `- [${title}](/reviews/${slug})\n`;
            }
        }
    }

    // Write output
    fs.writeFileSync(OUTPUT_FILE, output);

    console.log('âœ… Updated:', OUTPUT_FILE);
    console.log(`ðŸ“Š Total reviews: ${reviews.length}`);
    console.log('\nBy category:');
    for (const [cat, items] of Object.entries(byCategory).sort()) {
        console.log(`   ${cat}: ${items.length}`);
    }
}

main();
