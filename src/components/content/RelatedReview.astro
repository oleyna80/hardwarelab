---
import { getEntry } from 'astro:content';
import { Image } from 'astro:assets';

interface Props {
  slug: string;
  label?: string;
}

const { slug, label } = Astro.props;

// Normalize slug: remove any leading slash, ensure no double 'en/'
// If slug starts with '/', remove it
let normalizedSlug = slug.replace(/^\//, '');

// If slug doesn't start with language prefix (e.g. 'en/'), assume 'en/'
// In a full i18n setup, we should determine current locale, but for now defaulting to 'en' structure check
if (!normalizedSlug.startsWith('en/') && !normalizedSlug.startsWith('ru/') && !normalizedSlug.startsWith('de/') && !normalizedSlug.startsWith('fr/')) {
    normalizedSlug = `en/${normalizedSlug}`;
}

// Remove '/reviews/' prefix if present (e.g. from copy-pasting URL)
normalizedSlug = normalizedSlug.replace('reviews/', '');

const review = await getEntry('reviews', normalizedSlug);

if (!review) {
  console.warn(`RelatedReview: Could not find review with slug "${normalizedSlug}" (original: "${slug}")`);
  return null;
}

const { title, description, heroImage, rating } = review.data;
---

<a href={`/reviews/${normalizedSlug.replace(/^en\//, '')}`} class="group relative flex flex-col sm:flex-row gap-4 p-4 my-6 rounded-xl border border-zinc-200 dark:border-zinc-800 bg-zinc-50 dark:bg-zinc-900/50 hover:bg-white dark:hover:bg-zinc-900 hover:border-indigo-500/30 dark:hover:border-indigo-500/30 transition-all shadow-sm hover:shadow-md no-underline">
  {/* Image */}
  <div class="shrink-0 w-full sm:w-32 h-32 rounded-lg overflow-hidden bg-zinc-200 dark:bg-zinc-800 relative">
    {heroImage && (
      typeof heroImage === 'string' ? (
        <img
          src={heroImage}
          alt={title}
          class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
          loading="lazy"
        />
      ) : (
        <Image
          src={heroImage}
          alt={title}
          width={200}
          height={200}
          class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
        />
      )
    )}
  </div>

  {/* Content */}
  <div class="flex flex-col flex-grow justify-center">
    {label && (
      <span class="text-xs font-bold text-indigo-600 dark:text-indigo-400 mb-1 uppercase tracking-wider">
        {label}
      </span>
    )}
    <h3 class="font-bold text-lg leading-tight text-zinc-900 dark:text-zinc-100 group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors mb-1">
      {title}
    </h3>
    <p class="text-sm text-zinc-600 dark:text-zinc-400 line-clamp-2 mb-2">
      {description}
    </p>
    
    <div class="flex items-center gap-3 text-xs font-medium text-zinc-500 dark:text-zinc-500 mt-auto">
      <span class="flex items-center gap-1 text-yellow-500">
        ★ {rating}
      </span>
      <span class="group-hover:underline decoration-indigo-500/30 underline-offset-4">Read Review →</span>
    </div>
  </div>
</a>
