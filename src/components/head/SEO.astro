---
export interface Props {
    title: string;
    description: string;
    image?: string | { src: string } | undefined;
    article?: boolean;
    pubDate?: Date;
    lang?: "en" | "fr" | "ru" | "de";
    review?: {
        productName: string;
        rating: number;
        image?: string | { src: string } | undefined;
        pubDate?: Date;
    };
}

const {
    title,
    description,
    image,
    article = false,
    pubDate,
    lang = "en",
    review,
} = Astro.props;

const siteUrl = import.meta.env.SITE || "https://hardwarelab.org";
const canonicalURL = new URL(Astro.url.pathname, siteUrl);
const canonicalUrlString = canonicalURL.toString();

// Format date for ld+json if it's an article
const isoDate = pubDate ? new Date(pubDate).toISOString() : undefined;

const resolveImagePath = (img?: string | { src: string } | undefined) => {
    if (!img) return undefined;
    if (typeof img === "string") return img;
    if ("src" in img) return img.src;
    return undefined;
};

const resolvedImage = resolveImagePath(image);

// Default image if none provided
const ogImage = resolvedImage
    ? new URL(resolvedImage, siteUrl)
    : new URL("/og-default.jpg", siteUrl);

// Hreflang generation
const languages = ["en", "fr", "ru", "de"];
const currentPath = Astro.url.pathname;

// Remove language prefix to get the base path
// Example: /fr/reviews/foo -> /reviews/foo
// Example: /reviews/foo -> /reviews/foo (if default en)
let basePath = currentPath;
const pathParts = currentPath.split("/").filter(Boolean);

const firstPathPart = pathParts[0];
if (firstPathPart && languages.includes(firstPathPart)) {
    basePath = "/" + pathParts.slice(1).join("/");
} else if (currentPath === "/") {
    basePath = "/";
}

// Generate hreflang links
const hreflangLinks = languages.map((l) => {
    let href;
    if (l === "en") {
        href = basePath === "/" ? `${siteUrl}` : `${siteUrl}${basePath}`;
    } else {
        href =
            basePath === "/"
                ? `${siteUrl}/${l}/`
                : `${siteUrl}/${l}${basePath}`;
    }
    // Clean up double slashes
    href = href.replace(/([^:]\/)\/+/g, "$1");

    return {
        lang: l,
        href: href,
    };
});

// JSON-LD Schema
const baseSchema = article
    ? {
          "@context": "https://schema.org",
          "@type": "Article",
          headline: title,
          image: [ogImage.toString()],
          datePublished: isoDate,
          dateModified: isoDate, // Should preferably use lastUpdated if available
          author: [
              {
                  "@type": "Organization",
                  name: "HardwareLab",
                  url: siteUrl,
              },
          ],
      }
    : {
          "@context": "https://schema.org",
          "@type": "WebSite",
          name: "HardwareLab",
          url: siteUrl,
      };

const reviewImagePath = resolveImagePath(review?.image) || resolvedImage;
const reviewImageUrl = reviewImagePath
    ? new URL(reviewImagePath, siteUrl).toString()
    : ogImage.toString();
const reviewDate = review?.pubDate
    ? new Date(review.pubDate).toISOString()
    : isoDate;
const productId = `${canonicalUrlString}#product`;
const reviewId = `${canonicalUrlString}#review`;

const productSchema = review
    ? {
          "@context": "https://schema.org",
          "@type": "Product",
          "@id": productId,
          name: review.productName,
          image: [reviewImageUrl],
          url: canonicalUrlString,
      }
    : null;

const reviewSchema = review
    ? {
          "@context": "https://schema.org",
          "@type": "Review",
          "@id": reviewId,
          itemReviewed: {
              "@id": productId,
          },
          reviewRating: {
              "@type": "Rating",
              ratingValue: review.rating,
              bestRating: "5",
              worstRating: "1",
          },
          author: [
              {
                  "@type": "Organization",
                  name: "HardwareLab",
                  url: siteUrl,
              },
          ],
          datePublished: reviewDate,
      }
    : null;

const schema = [baseSchema, productSchema, reviewSchema].filter(Boolean);

// Map lang to og:locale format
const ogLocaleMap: Record<string, string> = {
    en: "en_US",
    fr: "fr_FR",
    ru: "ru_RU",
    de: "de_DE",
};
const ogLocale = ogLocaleMap[lang] || "en_US";
---

<!-- Global Metadata -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
<meta name="generator" content={Astro.generator} />

<!-- Canonical URL -->
<link rel="canonical" href={canonicalURL} />

<!-- Hreflang Tags -->
{
    hreflangLinks.map((link) => (
        <link rel="alternate" hreflang={link.lang} href={link.href} />
    ))
}
<link rel="alternate" hreflang="x-default" href={siteUrl + basePath} />

<!-- Primary Meta Tags -->
<title>{title}</title>
<meta name="title" content={title} />
<meta name="description" content={description} />

<!-- Open Graph / Facebook -->
<meta property="og:type" content={article ? "article" : "website"} />
<meta property="og:url" content={Astro.url} />
<meta property="og:title" content={title} />
<meta property="og:description" content={description} />
<meta property="og:image" content={ogImage} />
<meta property="og:locale" content={ogLocale} />
<meta property="og:site_name" content="HardwareLab" />

<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:url" content={Astro.url} />
<meta property="twitter:title" content={title} />
<meta property="twitter:description" content={description} />
<meta property="twitter:image" content={ogImage} />

<!-- JSON-LD Schema -->
<script
    is:inline
    type="application/ld+json"
    set:html={JSON.stringify(schema.length === 1 ? schema[0] : schema)}
/>
