---
import type { CollectionEntry } from "astro:content";
import type { Language } from "@/utils/i18n";

interface Props {
    reviews: CollectionEntry<"reviews">[];
    lang?: Language;
}

const { reviews, lang = "en" } = Astro.props;

// Take only the first 5 reviews
const carouselReviews = reviews.slice(0, 5);
---

<div
    class="review-banner-carousel relative w-full overflow-hidden rounded-2xl shadow-2xl"
>
    <!-- Carousel Container -->
    <div
        class="carousel-track flex transition-transform duration-700 ease-in-out"
    >
        {
            carouselReviews.map((review, index) => {
                const { title, heroImage } = review.data;
                const slug = review.id
                    .replace(/^[a-z]{2}\//, "")
                    .replace(/\.mdx$/, "");
                const reviewUrl = `/${lang === "en" ? "" : lang + "/"}reviews/${slug}`;

                return (
                    <div class="carousel-slide min-w-full relative">
                        <a
                            href={reviewUrl}
                            class="block relative h-[400px] md:h-[500px] overflow-hidden group"
                        >
                            {/* Background Image */}
                            {heroImage ? (
                                <img
                                    src={heroImage}
                                    alt={title}
                                    class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-700"
                                />
                            ) : (
                                <div class="w-full h-full bg-gradient-to-br from-indigo-600 via-purple-600 to-cyan-600" />
                            )}

                            {/* Gradient Overlay */}
                            <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent" />

                            {/* Content */}
                            <div class="absolute bottom-0 left-0 right-0 p-8 md:p-12 text-white">
                                <h3 class="text-3xl md:text-5xl font-bold mb-4 drop-shadow-lg">
                                    {title}
                                </h3>
                                <span class="inline-block px-4 py-2 bg-accent-600 hover:bg-accent-700 rounded-lg font-semibold transition-colors">
                                    Read Review â†’
                                </span>
                            </div>
                        </a>
                    </div>
                );
            })
        }
    </div>

    <!-- Navigation Arrows -->
    <button
        class="carousel-prev absolute left-4 top-1/2 -translate-y-1/2 w-12 h-12 bg-white/20 hover:bg-white/30 backdrop-blur-md rounded-full flex items-center justify-center transition-all duration-300 hover:scale-110 z-10"
        aria-label="Previous slide"
    >
        <svg
            class="w-6 h-6 text-white"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
        >
            <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 19l-7-7 7-7"></path>
        </svg>
    </button>

    <button
        class="carousel-next absolute right-4 top-1/2 -translate-y-1/2 w-12 h-12 bg-white/20 hover:bg-white/30 backdrop-blur-md rounded-full flex items-center justify-center transition-all duration-300 hover:scale-110 z-10"
        aria-label="Next slide"
    >
        <svg
            class="w-6 h-6 text-white"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
        >
            <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 5l7 7-7 7"></path>
        </svg>
    </button>

    <!-- Indicators -->
    <div
        class="carousel-indicators absolute bottom-6 left-1/2 -translate-x-1/2 flex gap-2 z-10"
    >
        {
            carouselReviews.map((_, index) => (
                <button
                    class="carousel-indicator w-3 h-3 rounded-full bg-white/40 hover:bg-white/60 transition-all duration-300"
                    data-index={index}
                    aria-label={`Go to slide ${index + 1}`}
                />
            ))
        }
    </div>
</div>

<script>
    class ReviewCarousel {
        private track: HTMLElement;
        private slides: NodeListOf<HTMLElement>;
        private prevBtn: HTMLButtonElement;
        private nextBtn: HTMLButtonElement;
        private indicators: NodeListOf<HTMLButtonElement>;
        private currentIndex: number = 0;
        private autoPlayInterval: number | null = null;
        private readonly autoPlayDelay: number = 5000; // 5 seconds

        constructor(container: HTMLElement) {
            this.track = container.querySelector(
                ".carousel-track",
            ) as HTMLElement;
            this.slides = container.querySelectorAll(".carousel-slide");
            this.prevBtn = container.querySelector(
                ".carousel-prev",
            ) as HTMLButtonElement;
            this.nextBtn = container.querySelector(
                ".carousel-next",
            ) as HTMLButtonElement;
            this.indicators = container.querySelectorAll(".carousel-indicator");

            this.init();
        }

        private init(): void {
            // Set initial active indicator
            this.updateIndicators();

            // Event listeners
            this.prevBtn.addEventListener("click", () => this.prev());
            this.nextBtn.addEventListener("click", () => this.next());

            this.indicators.forEach((indicator, index) => {
                indicator.addEventListener("click", () =>
                    this.goToSlide(index),
                );
            });

            // Auto-play
            this.startAutoPlay();

            // Pause on hover
            this.track.addEventListener("mouseenter", () =>
                this.stopAutoPlay(),
            );
            this.track.addEventListener("mouseleave", () =>
                this.startAutoPlay(),
            );
        }

        private goToSlide(index: number): void {
            this.currentIndex = index;
            this.updateCarousel();
        }

        private next(): void {
            this.currentIndex = (this.currentIndex + 1) % this.slides.length;
            this.updateCarousel();
        }

        private prev(): void {
            this.currentIndex =
                (this.currentIndex - 1 + this.slides.length) %
                this.slides.length;
            this.updateCarousel();
        }

        private updateCarousel(): void {
            const offset = -this.currentIndex * 100;
            this.track.style.transform = `translateX(${offset}%)`;
            this.updateIndicators();
        }

        private updateIndicators(): void {
            this.indicators.forEach((indicator, index) => {
                if (index === this.currentIndex) {
                    indicator.classList.add("!bg-white", "w-8");
                } else {
                    indicator.classList.remove("!bg-white", "w-8");
                }
            });
        }

        private startAutoPlay(): void {
            this.stopAutoPlay();
            this.autoPlayInterval = window.setInterval(() => {
                this.next();
            }, this.autoPlayDelay);
        }

        private stopAutoPlay(): void {
            if (this.autoPlayInterval !== null) {
                clearInterval(this.autoPlayInterval);
                this.autoPlayInterval = null;
            }
        }
    }

    // Initialize all carousels on the page
    document.addEventListener("DOMContentLoaded", () => {
        const carousels = document.querySelectorAll(".review-banner-carousel");
        carousels.forEach((carousel) => {
            new ReviewCarousel(carousel as HTMLElement);
        });
    });
</script>

<style>
    .carousel-indicator.active {
        background-color: white;
        width: 2rem;
    }
</style>
