---
import { getCollection } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import ProductHeader from "@/components/ui/ProductHeader.astro";
import AffiliateButton from "@/components/ui/AffiliateButton.astro";
import ShareButtons from "@/components/ui/ShareButtons.astro";

export async function getStaticPaths() {
  const reviews = await getCollection("reviews");

  // Фильтруем только EN обзоры (id начинается с 'en/')
  const enReviews = reviews.filter((review) => review.slug.startsWith("en/"));

  // Генерируем параметры slug как часть после 'en/'
  const paths = enReviews.map((review) => {
    const slug = review.slug.replace(/^en\//, "");
    return {
      params: { slug },
    };
  });

  return paths;
}

const { slug } = Astro.params;

// Получаем все обзоры и находим нужный по slug с префиксом 'en/'
const allReviews = await getCollection("reviews");

// slug - массив, берем первый элемент
const slugString = Array.isArray(slug) ? slug[0] : slug;

const review = allReviews.find((r) => r.slug === `en/${slugString}`);

if (!review) {
  return Astro.redirect("/404");
}

const { Content: ReviewContent } = await review.render();
const frontmatter = review.data;

---

<Layout
  title={frontmatter.title}
  description={frontmatter.description}
  image={frontmatter.ogImage || frontmatter.heroImage}
  article={true}
  pubDate={frontmatter.pubDate}
  review={{
    productName: frontmatter.title,
    rating: frontmatter.rating,
    ...(frontmatter.ogImage || frontmatter.heroImage
      ? { image: frontmatter.ogImage || frontmatter.heroImage }
      : {}),
    pubDate: frontmatter.pubDate,
  }}
>
  <article class="max-w-4xl mx-auto px-4 py-8">
    <ProductHeader
      title={frontmatter.title}
      rating={frontmatter.rating}
      asin={frontmatter.asin}
      priceCategory={frontmatter.priceCategory}
    />

    {/* Основной контент */}
    <div class="prose prose-lg dark:prose-invert max-w-none mt-8">
      <ReviewContent />
    </div>

    {/* Social Share Buttons */}
    <div class="mt-8">
      <ShareButtons
        title={frontmatter.title}
        description={frontmatter.description}
      />
    </div>

    {/* Аффилированная кнопка (липкая внизу) */}
    <div class="mt-12 sticky bottom-6 z-10">
      <div
        class="bg-primary-900/90 dark:bg-primary-950/90 backdrop-blur-lg rounded-xl p-4 shadow-2xl border border-accent-500/30"
      >
        <div
          class="flex flex-col sm:flex-row items-center justify-between gap-4"
        >
          <div class="text-center sm:text-left">
            <h3 class="font-bold text-lg">Ready to buy?</h3>
            <p class="text-primary-300 text-sm">
              Check the latest price on Amazon
            </p>
          </div>
          <AffiliateButton
            asin={frontmatter.asin || ""}
            label="Check Price on Amazon"
            variant="primary"
            size="lg"
            icon={true}
          />
        </div>
      </div>
    </div>
  </article>
</Layout>
